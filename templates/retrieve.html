{% extends "base.html" %}

{% block title %}Retrieve Information - RAG Pipeline{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg p-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Retrieve Information</h1>
    <form id="retrieveForm" class="space-y-4">
        <div>
            <label for="query" class="block text-sm font-medium text-gray-700 mb-1">Search Query</label>
            <input type="text" id="query" name="query" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Enter your search query...">
        </div>
        <div>
            <label for="top_k" class="block text-sm font-medium text-gray-700 mb-1">Number of Results</label>
            <input type="number" id="top_k" name="top_k" min="1" max="100" value="10"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Number of results to show">
        </div>
        <div class="flex items-center">
            <input type="checkbox" id="group_by_doc" name="group_by_doc" checked
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="group_by_doc" class="ml-2 block text-sm text-gray-700">
                Group by Document
            </label>
        </div>
        <button type="submit"
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Search
        </button>
    </form>

    <div id="results" class="mt-8">
        {% if results %}
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Search Results</h2>
        <div class="space-y-4">
            {% for result in results %}
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-gray-700">{{ result.text }}</p>
                <p class="text-sm text-gray-500 mt-2">Score: {{ result.score }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<script>
document.getElementById('retrieveForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = document.getElementById('query').value;
    const top_k = document.getElementById('top_k').value;
    const group_by_doc = document.getElementById('group_by_doc').checked;
    
    try {
        const response = await fetch('/retrieve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                query,
                top_k: parseInt(top_k),
                group_by_doc
            }),
        });
        
        const data = await response.json();
        const resultsDiv = document.getElementById('results');
        
        if (response.ok) {
            if (data.results && data.results.length > 0) {
                resultsDiv.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Search Results</h2>
                    <div class="space-y-4">
                        ${data.results.map(result => {
                            if (result.chunks) {
                                // Grouped results (by document)
                                return `
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <div class="mb-2">
                                            <span class="text-sm font-medium text-gray-500">Document:</span>
                                            <span class="text-sm text-gray-700">${result.call_name}</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-sm font-medium text-gray-500">URL:</span>
                                            <a href="${result.url}" class="text-sm text-blue-600 hover:underline">${result.url}</a>
                                        </div>
                                        <div class="space-y-2">
                                            ${result.chunks.map(chunk => `
                                                <div class="p-3 bg-white rounded border border-gray-200">
                                                    <p class="text-gray-700">${chunk.text}</p>
                                                    <p class="text-sm text-gray-500 mt-1">Score: ${chunk.score.toFixed(4)}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="mt-2 text-sm text-gray-500">
                                            Average Score: ${result.avg_score.toFixed(4)}
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Individual chunks
                                return `
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <div class="mb-2">
                                            <span class="text-sm font-medium text-gray-500">Source:</span>
                                            <span class="text-sm text-gray-700">${result.call_name}</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-sm font-medium text-gray-500">URL:</span>
                                            <a href="${result.url}" class="text-sm text-blue-600 hover:underline">${result.url}</a>
                                        </div>
                                        <p class="text-gray-700">${result.text}</p>
                                        <p class="text-sm text-gray-500 mt-2">Score: ${result.score.toFixed(4)}</p>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <p class="text-yellow-800">No results found for your query.</p>
                    </div>
                `;
            }
        } else {
            resultsDiv.innerHTML = `
                <div class="p-4 bg-red-50 rounded-lg">
                    <p class="text-red-800">Error: ${data.detail}</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('results').innerHTML = `
            <div class="p-4 bg-red-50 rounded-lg">
                <p class="text-red-800">Error: ${error.message}</p>
            </div>
        `;
    }
});
</script>
{% endblock %} 